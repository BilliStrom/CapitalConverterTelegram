const { Telegraf, Markup } = require('telegraf');
const { Redis } = require('@upstash/redis');

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Redis
const redis = new Redis({
  url: process.env.UPSTASH_REDIS_REST_URL,
  token: process.env.UPSTASH_REDIS_REST_TOKEN,
});

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
const CONFIG = {
  ADMIN_ID: process.env.ADMIN_ID || 5948326124,
  FREE_SEARCH_LIMIT: 3,
  PREMIUM_COST: 100,
  SESSION_TIMEOUT: 600000,
  CHAT_TIMEOUT: 1800000,
  SEARCH_TIMEOUT: 300000,
  TERMS_URL: 'https://yourwebsite.com/terms',
  PRIVACY_URL: 'https://yourwebsite.com/privacy',
  SUPPORT_URL: 'https://t.me/your_support'
};

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Redis
const redisHelpers = {
  setUser: async (userId, data) => {
    try {
      await redis.set(`user:${userId}`, JSON.stringify(data));
      return true;
    } catch (error) {
      console.error('Error setting user:', error);
      return false;
    }
  },

  getUser: async (userId) => {
    try {
      const data = await redis.get(`user:${userId}`);
      return data ? JSON.parse(data) : null;
    } catch (error) {
      console.error('Error getting user:', error);
      return null;
    }
  }
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
function getMainMenu() {
  return Markup.keyboard([
    ['üîç –ù–∞–π—Ç–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞', 'üöª –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å'],
    ['üíé –ü—Ä–µ–º–∏—É–º –ø–æ–¥–ø–∏—Å–∫–∞', 'üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞'],
    ['üìú –ü—Ä–∞–≤–∏–ª–∞', '‚ùå –í—ã—Ö–æ–¥']
  ]).resize();
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
const bot = new Telegraf(process.env.BOT_TOKEN);

// –ö–æ–º–∞–Ω–¥–∞ /start - –Ω–∞—á–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞
bot.command('start', async (ctx) => {
  try {
    const userId = ctx.from.id;
    let user = await redisHelpers.getUser(userId);
    
    if (!user) {
      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      user = {
        id: userId,
        username: ctx.from.username || '',
        first_name: ctx.from.first_name || '',
        last_name: ctx.from.last_name || '',
        ageVerified: false,
        termsAccepted: false,
        gender: null,
        searches: 0,
        premium: false,
        createdAt: new Date().toISOString()
      };
      
      await redisHelpers.setUser(userId, user);
      
      // –ó–∞–ø—Ä–æ—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–æ–∑—Ä–∞—Å—Ç–∞
      await ctx.reply(
        'üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∞–Ω–æ–Ω–∏–º–Ω—ã–π —á–∞—Ç!\n\n–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –≤–∞–º –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 18 –ª–µ—Ç.',
        Markup.inlineKeyboard([
          [Markup.button.callback('‚úÖ –î–∞, –º–Ω–µ –µ—Å—Ç—å 18 –ª–µ—Ç', 'age_confirm_yes')],
          [Markup.button.callback('‚ùå –ù–µ—Ç', 'age_confirm_no')]
        ])
      );
    } else if (!user.ageVerified) {
      // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –≤–æ–∑—Ä–∞—Å—Ç
      await ctx.reply(
        '–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –≤–∞–º –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 18 –ª–µ—Ç.',
        Markup.inlineKeyboard([
          [Markup.button.callback('‚úÖ –î–∞, –º–Ω–µ –µ—Å—Ç—å 18 –ª–µ—Ç', 'age_confirm_yes')],
          [Markup.button.callback('‚ùå –ù–µ—Ç', 'age_confirm_no')]
        ])
      );
    } else if (!user.termsAccepted) {
      // –í–æ–∑—Ä–∞—Å—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω, –Ω–æ –Ω–µ –ø—Ä–∏–Ω—è—Ç—ã –ø—Ä–∞–≤–∏–ª–∞
      await ctx.reply(
        `üìú –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–∑–Ω–∞–∫–æ–º—å—Ç–µ—Å—å —Å –Ω–∞—à–∏–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏:\n\n` +
        `1. –ó–∞–ø—Ä–µ—â–µ–Ω—ã –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è –∏ —É–≥—Ä–æ–∑—ã\n` +
        `2. –ó–∞–ø—Ä–µ—â–µ–Ω —Å–ø–∞–º –∏ —Ä–µ–∫–ª–∞–º–∞\n` +
        `3. –ó–∞–ø—Ä–µ—â–µ–Ω –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –≤–∑—Ä–æ—Å–ª—ã—Ö\n` +
        `4. –£–≤–∞–∂–∞–π—Ç–µ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n\n` +
        `–ü–æ–ª–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞: ${CONFIG.TERMS_URL}\n` +
        `–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏: ${CONFIG.PRIVACY_URL}`,
        Markup.inlineKeyboard([
          [Markup.button.callback('‚úÖ –ü—Ä–∏–Ω–∏–º–∞—é –ø—Ä–∞–≤–∏–ª–∞', 'terms_accept')],
          [Markup.button.callback('‚ùå –ù–µ –ø—Ä–∏–Ω–∏–º–∞—é', 'terms_decline')]
        ])
      );
    } else if (!user.gender) {
      // –ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–Ω—è—Ç—ã, –Ω–æ –Ω–µ —É–∫–∞–∑–∞–Ω –ø–æ–ª
      await ctx.reply(
        '–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø–æ–ª:',
        Markup.inlineKeyboard([
          [Markup.button.callback('üë® –ú—É–∂—Å–∫–æ–π', 'gender_male')],
          [Markup.button.callback('üë© –ñ–µ–Ω—Å–∫–∏–π', 'gender_female')]
        ])
      );
    } else {
      // –í—Å–µ –¥–∞–Ω–Ω—ã–µ –µ—Å—Ç—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
      await ctx.reply(
        '–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:',
        getMainMenu()
      );
    }
  } catch (error) {
    console.error('Error in start command:', error);
    await ctx.reply('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
  }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–æ–∑—Ä–∞—Å—Ç–∞
bot.action('age_confirm_yes', async (ctx) => {
  try {
    await ctx.answerCbQuery();
    const userId = ctx.from.id;
    const user = await redisHelpers.getUser(userId);
    
    if (user) {
      user.ageVerified = true;
      await redisHelpers.setUser(userId, user);
      
      // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–∏–Ω—è—Ç–∏–µ –ø—Ä–∞–≤–∏–ª
      await ctx.editMessageText(
        `üìú –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–∑–Ω–∞–∫–æ–º—å—Ç–µ—Å—å —Å –Ω–∞—à–∏–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏:\n\n` +
        `1. –ó–∞–ø—Ä–µ—â–µ–Ω—ã –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è –∏ —É–≥—Ä–æ–∑—ã\n` +
        `2. –ó–∞–ø—Ä–µ—â–µ–Ω —Å–ø–∞–º –∏ —Ä–µ–∫–ª–∞–º–∞\n` +
        `3. –ó–∞–ø—Ä–µ—â–µ–Ω –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –≤–∑—Ä–æ—Å–ª—ã—Ö\n` +
        `4. –£–≤–∞–∂–∞–π—Ç–µ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n\n` +
        `–ü–æ–ª–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞: ${CONFIG.TERMS_URL}\n` +
        `–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏: ${CONFIG.PRIVACY_URL}`,
        {
          reply_markup: {
            inline_keyboard: [
              [{ text: '‚úÖ –ü—Ä–∏–Ω–∏–º–∞—é –ø—Ä–∞–≤–∏–ª–∞', callback_data: 'terms_accept' }],
              [{ text: '‚ùå –ù–µ –ø—Ä–∏–Ω–∏–º–∞—é', callback_data: 'terms_decline' }]
            ]
          }
        }
      );
    }
  } catch (error) {
    console.error('Error in age confirmation:', error);
    await ctx.answerCbQuery('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
  }
});

bot.action('age_confirm_no', async (ctx) => {
  try {
    await ctx.answerCbQuery();
    await ctx.editMessageText('‚ùå –ò–∑–≤–∏–Ω–∏—Ç–µ, —ç—Ç–æ—Ç —Å–µ—Ä–≤–∏—Å –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ–ª–µ—Ç–Ω–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.');
  } catch (error) {
    console.error('Error in age rejection:', error);
    await ctx.answerCbQuery('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
  }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –ø—Ä–∞–≤–∏–ª
bot.action('terms_accept', async (ctx) => {
  try {
    await ctx.answerCbQuery();
    const userId = ctx.from.id;
    const user = await redisHelpers.getUser(userId);
    
    if (user) {
      user.termsAccepted = true;
      await redisHelpers.setUser(userId, user);
      
      // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–ª
      await ctx.editMessageText(
        '–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø–æ–ª:',
        {
          reply_markup: {
            inline_keyboard: [
              [{ text: 'üë® –ú—É–∂—Å–∫–æ–π', callback_data: 'gender_male' }],
              [{ text: 'üë© –ñ–µ–Ω—Å–∫–∏–π', callback_data: 'gender_female' }]
            ]
          }
        }
      );
    }
  } catch (error) {
    console.error('Error in terms acceptance:', error);
    await ctx.answerCbQuery('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
  }
});

bot.action('terms_decline', async (ctx) => {
  try {
    await ctx.answerCbQuery();
    await ctx.editMessageText('‚ùå –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–Ω—è—Ç—å –ø—Ä–∞–≤–∏–ª–∞. –ï—Å–ª–∏ –ø–µ—Ä–µ–¥—É–º–∞–µ—Ç–µ - –∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ —Å–Ω–æ–≤–∞ –∫–æ–º–∞–Ω–¥–æ–π /start');
  } catch (error) {
    console.error('Error in terms rejection:', error);
    await ctx.answerCbQuery('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
  }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–æ–ª–∞
bot.action(/^gender_(male|female)$/, async (ctx) => {
  try {
    await ctx.answerCbQuery();
    const userId = ctx.from.id;
    const gender = ctx.match[1];
    const user = await redisHelpers.getUser(userId);
    
    if (user) {
      user.gender = gender;
      await redisHelpers.setUser(userId, user);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
      await ctx.editMessageText(
        '–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–æ—Ç–∞.',
        getMainMenu()
      );
    }
  } catch (error) {
    console.error('Error in gender selection:', error);
    await ctx.answerCbQuery('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
  }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
bot.on('text', async (ctx) => {
  try {
    const userId = ctx.from.id;
    const text = ctx.message.text;
    const user = await redisHelpers.getUser(userId);

    if (!user || !user.ageVerified || !user.termsAccepted || !user.gender) {
      // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ /start
      return ctx.reply('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≤–µ—Ä—à–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é:', Markup.inlineKeyboard([
        [Markup.button.callback('–ù–∞—á–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é', 'start_registration')]
      ]));
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
    switch (text) {
      case 'üîç –ù–∞–π—Ç–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞':
        await ctx.reply('üîç –ü–æ–∏—Å–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...');
        // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞
        break;
      case 'üöª –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å':
        const profileText = `üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å:\n\n` +
          `–ò–º—è: ${user.first_name} ${user.last_name}\n` +
          `Username: @${user.username || '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n` +
          `–ü–æ–ª: ${user.gender === 'male' ? 'üë® –ú—É–∂—Å–∫–æ–π' : 'üë© –ñ–µ–Ω—Å–∫–∏–π'}\n` +
          `–ü–æ–∏—Å–∫–æ–≤ —Å–µ–≥–æ–¥–Ω—è: ${user.searches}/${CONFIG.FREE_SEARCH_LIMIT}\n` +
          `–°—Ç–∞—Ç—É—Å: ${user.premium ? 'üíé –ü—Ä–µ–º–∏—É–º' : 'üîì –û–±—ã—á–Ω—ã–π'}`;
        await ctx.reply(profileText);
        break;
      case 'üíé –ü—Ä–µ–º–∏—É–º –ø–æ–¥–ø–∏—Å–∫–∞':
        await ctx.reply(
          `üíé –ü—Ä–µ–º–∏—É–º –ø–æ–¥–ø–∏—Å–∫–∞:\n\n` +
          `‚Ä¢ –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∏—Å–∫–æ–≤\n` +
          `‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤ –ø–æ–∏—Å–∫–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤\n` +
          `‚Ä¢ –î–æ—Å—Ç—É–ø –∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ\n\n` +
          `–°—Ç–æ–∏–º–æ—Å—Ç—å: ${CONFIG.PREMIUM_COST} —Ä—É–±.`,
          Markup.inlineKeyboard([
            [Markup.button.callback('üí≥ –ö—É–ø–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É', 'buy_premium')]
          ])
        );
        break;
      case 'üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞':
        await ctx.reply(`üìû –ü–æ –≤—Å–µ–º –≤–æ–ø—Ä–æ—Å–∞–º –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É: ${CONFIG.SUPPORT_URL}`);
        break;
      case 'üìú –ü—Ä–∞–≤–∏–ª–∞':
        await ctx.reply(
          `üìú –ü—Ä–∞–≤–∏–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:\n\n` +
          `1. –ó–∞–ø—Ä–µ—â–µ–Ω—ã –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è –∏ —É–≥—Ä–æ–∑—ã\n` +
          `2. –ó–∞–ø—Ä–µ—â–µ–Ω —Å–ø–∞–º –∏ —Ä–µ–∫–ª–∞–º–∞\n` +
          `3. –ó–∞–ø—Ä–µ—â–µ–Ω –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –≤–∑—Ä–æ—Å–ª—ã—Ö\n` +
          `4. –£–≤–∞–∂–∞–π—Ç–µ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n\n` +
          `–ü–æ–ª–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞: ${CONFIG.TERMS_URL}`
        );
        break;
      case '‚ùå –í—ã—Ö–æ–¥':
        await ctx.reply(
          '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?',
          Markup.keyboard([
            ['‚úÖ –î–∞, –≤—ã–π—Ç–∏', '‚ùå –ù–µ—Ç, –æ—Å—Ç–∞—Ç—å—Å—è']
          ]).resize()
        );
        break;
      default:
        await ctx.reply('–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏:', getMainMenu());
    }
  } catch (error) {
    console.error('Error in text processing:', error);
    await ctx.reply('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
  }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –Ω–∞—á–∞–ª–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
bot.action('start_registration', async (ctx) => {
  try {
    await ctx.answerCbQuery();
    await ctx.deleteMessage();
    await ctx.reply(
      '–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –≤–∞–º –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 18 –ª–µ—Ç.',
      Markup.inlineKeyboard([
        [Markup.button.callback('‚úÖ –î–∞, –º–Ω–µ –µ—Å—Ç—å 18 –ª–µ—Ç', 'age_confirm_yes')],
        [Markup.button.callback('‚ùå –ù–µ—Ç', 'age_confirm_no')]
      ])
    );
  } catch (error) {
    console.error('Error in start registration:', error);
    await ctx.answerCbQuery('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
  }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è Vercel
module.exports = async (req, res) => {
  try {
    if (req.method === 'POST') {
      await bot.handleUpdate(req.body, res);
    } else {
      res.status(200).json({ 
        status: 'active', 
        service: 'Anonymous Chat Bot', 
        version: '3.0' 
      });
    }
  } catch (err) {
    console.error('Error:', err);
    res.status(500).json({ error: 'Internal error' });
  }
};

console.log('Anonymous Chat Bot started');
